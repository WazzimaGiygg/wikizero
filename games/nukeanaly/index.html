<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase CMS - Gerenciador de Conteúdo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .google-button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            background-color: #4285F4;
            color: white;
            transition: background-color 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .google-button:hover {
            background-color: #357ae8;
            transform: scale(1.05);
        }
        .google-icon {
            width: 24px;
            height: 24px;
            margin-right: 12px;
        }
        #copy-url-button {
            background-color: #4caf50;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.875rem;
            margin-top: 8px;
        }
        #copy-url-button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div id="admin-container" class="container bg-white rounded-xl shadow-lg p-8 space-y-6 max-w-2xl w-full">
        <h1 class="text-3xl font-bold text-center text-blue-700">Firebase CMS - Gerenciador de Conteúdo</h1>
        <p class="text-gray-600 text-center">Faça login com uma conta de administrador para salvar e carregar conteúdo no Firestore.</p>
        <div id="status-message" class="text-center text-lg font-semibold p-4 rounded-lg bg-gray-200 text-gray-800">
            Por favor, faça login para continuar.
        </div>                
        <div id="auth-section" class="space-y-4">
            <h2 class="text-2xl font-bold text-center text-blue-700">Login</h2>                        
            <button id="googleLoginButton" class="w-full google-button">
                <svg class="google-icon" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M44.5 20H24V28H37C35.9 31.8 33.3 36.3 29.5 39.1L29.4 39.2L35 43.4L35.1 43.5C39 39.1 41.5 33.2 41.5 26.5C41.5 24.6 41.2 22.8 40.8 21.1H44.5Z" fill="#4285F4"/>
                    <path d="M24 44.5C30.6 44.5 36.2 42.4 40.8 38.6L35.1 34.4L35 34.3C33.2 35.7 30.7 36.6 28 36.6C22.6 36.6 18 33.1 16.2 27.9L16.1 27.8L10.3 32.2L10.2 32.3C12 36.7 17.5 41.5 24 41.5Z" fill="#34A853"/>
                    <path d="M9.9 27.9C9.4 26.4 9.1 24.7 9.1 23C9.1 21.3 9.4 19.6 9.9 18.1L9.9 18L4.1 13.7L4 13.8C2.1 17.8 1.1 22.3 1.1 27C1.1 31.7 2.1 36.2 4 40.2L9.9 36L9.9 27.9Z" fill="#FABC05"/>
                    <path d="M24 9.5C26.9 9.5 29.6 10.6 31.8 12.5L36.2 8.1C32.3 4.5 28.3 2.5 24 2.5C17.5 2.5 12 7.3 10.2 11.7L16.1 15.9C18 10.7 22.6 7.5 28 7.5Z" fill="#EA4335"/>
                </svg>
                Entrar com Google
            </button>
        </div>
        <div id="admin-controls" class="space-y-6" style="display:none;">
            <p id="user-info" class="text-center font-semibold text-gray-700">Bem-vindo, <span id="currentUserEmail"></span>!</p>
            <button id="logoutButton" class="w-full bg-red-500 text-white font-bold py-3 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 hover:bg-red-600">Sair</button>
            <hr class="border-gray-300">
            
            <div class="space-y-4">
                <h2 class="text-2xl font-bold text-blue-700">Salvar Conteúdo</h2>                                
                <div>
                    <label for="documentName" class="block text-gray-700 font-semibold mb-1">Nome do Documento (ID):</label>
                    <input type="text" id="documentName" placeholder="Ex: meu-primeiro-documento" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label for="internalName" class="block text-gray-700 font-semibold mb-1">Nome Interno:</label>
                    <input type="text" id="internalName" placeholder="Ex: Artigo sobre tecnologia" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>                                
                
                <div>
                    <label for="content" class="block text-gray-700 font-semibold mb-1">Conteúdo:</label>
                    <textarea id="content" placeholder="Insira seu conteúdo aqui..." rows="8" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>                                
                
                <button id="saveButton" onclick="saveContent()" class="w-full btn-primary text-white font-bold py-3 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">Salvar Conteúdo</button>
            </div>                        
            <hr class="border-gray-300">
            
            <div class="space-y-4">
                <h2 class="text-2xl font-bold text-blue-700">Abrir Conteúdo</h2>                                
                <div>
                    <label for="openDocumentName" class="block text-gray-700 font-semibold mb-1">Nome do Documento para Abrir (ID):</label>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="openDocumentName" placeholder="Ex: meu-primeiro-documento" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="copyPublicUrlButton" onclick="copyPublicUrl()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm transition duration-300 ease-in-out hover:bg-gray-300">Copiar URL Pública</button>
                    </div>
                </div>
                
                <button id="openButton" onclick="openContent()" class="w-full bg-green-500 text-white font-bold py-3 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 hover:bg-green-600">Abrir Conteúdo</button>
            </div>        
        </div>
        
        <div id="contentDisplay" class="bg-gray-50 p-6 rounded-lg shadow-inner space-y-4">
            <h3 class="text-xl font-bold text-blue-700">Conteúdo Recuperado:</h3>
            <p id="displayInternalName" class="text-gray-700">Nome Interno: <span class="font-normal text-gray-600">N/A</span></p>
            <p id="displayContent" class="text-gray-700">Conteúdo: <span class="font-normal text-gray-600">N/A</span></p>
        </div>
        
        <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 text-center">
                <p id="modal-message" class="text-lg font-medium mb-4"></p>
                <button onclick="hideModal()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-300">OK</button>
            </div>
        </div>
    </div>        
    
    <script type="module">
        // Importa os módulos necessários do Firebase (v11)
        import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- Variáveis globais do Canvas (não altere) ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;                
        
        let db, auth, app;
        let isUserAdmin = false;                
        
        // --- Lógica do Visualizador Público ---
        const publicUrlDomain = "wikizero.wzzm.org";
        const publicUrlPathPrefix = "/games/";
        const isPublicViewer = window.location.hostname === publicUrlDomain && window.location.pathname.startsWith(publicUrlPathPrefix);
        
        if (isPublicViewer) {
            const pathParts = window.location.pathname.split('/');
            const docIdFromUrl = pathParts[2];
            
            if (docIdFromUrl && docIdFromUrl.length > 0) {
                document.body.innerHTML = 'Carregando conteúdo...';
                
                try {
                    const publicApp = initializeApp(firebaseConfig, "public-app");
                    const publicAuth = getAuth(publicApp);
                    const publicDb = getFirestore(publicApp);
                    const collectionName = "HTML2W";
                    
                    signInAnonymously(publicAuth)
                        .then(() => {
                            const q = query(collection(publicDb, collectionName), where("nomeInterno", "==", docIdFromUrl));
                            
                            getDocs(q).then((querySnapshot) => {
                                if (!querySnapshot.empty) {
                                    const docData = querySnapshot.docs[0].data();
                                    document.body.innerHTML = docData.conteudo;
                                } else {
                                    document.body.innerHTML = `<div class="p-8 text-center text-red-500 font-bold">Conteúdo para "${docIdFromUrl}" não encontrado.</div>`;
                                }
                            }).catch(error => {
                                console.error("Erro ao buscar documento para visualização:", error);
                                document.body.innerHTML = `<div class="p-8 text-center text-red-500 font-bold">Erro ao carregar conteúdo: ${error.message}</div>`;
                            });
                        })
                        .catch(error => {
                            console.error("Erro ao autenticar anonimamente:", error);
                            document.body.innerHTML = `<div class="p-8 text-center text-red-500 font-bold">Erro de autenticação para leitura pública: ${error.message}</div>`;
                        });
                } catch (error) {
                    console.error("Erro fatal ao inicializar o Firebase para o visualizador:", error);
                    document.body.innerHTML = `<div class="p-8 text-center text-red-500 font-bold">Erro fatal na inicialização do Firebase: ${error.message}</div>`;
                }
            } else {
                document.body.innerHTML = `<div class="p-8 text-center text-red-500 font-bold">Documento não especificado na URL.</div>`;
            }
        } else {
            // --- Lógica do CMS Admin ---
            
            try {
                app = initializeApp(firebaseConfig, "admin-app");
                auth = getAuth(app);
                db = getFirestore(app);
                
                if (initialAuthToken) {
                    signInWithCustomToken(auth, initialAuthToken).then(() => {
                        console.log("Autenticação Canvas bem-sucedida.");
                    }).catch(error => {
                        console.error("Erro de autenticação Canvas:", error);
                    });
                } else {
                    console.warn("Nenhum token de autenticação Canvas encontrado.");
                }
                console.log("Firebase inicializado para o CMS com sucesso.");
            } catch (error) {
                console.error("Erro fatal ao inicializar o Firebase para o CMS:", error);
                const statusDiv = document.getElementById('status-message');
                statusDiv.textContent = `Erro fatal na inicialização do Firebase: ${error.message}`;
                statusDiv.className = 'text-center text-lg font-semibold p-4 rounded-lg bg-red-200 text-red-800';
                document.getElementById('admin-container').style.display = 'none';
            }
            
            // --- Funções de UI ---
            function showModal(msg) {
                const modal = document.getElementById('custom-modal');
                const modalMessage = document.getElementById('modal-message');
                modalMessage.textContent = msg;
                modal.style.display = 'flex';
            }
            
            window.hideModal = function() {
                const modal = document.getElementById('custom-modal');
                modal.style.display = 'none';
            }
            
            function showMessage(msg) {
                showModal(msg);
            }
            
            // --- Funções de Autenticação e Eventos ---
            const googleLoginButton = document.getElementById('googleLoginButton');
            const logoutButton = document.getElementById('logoutButton');
            
            const provider = new GoogleAuthProvider();
            
            googleLoginButton.addEventListener('click', async () => {
                try {
                    await signInWithPopup(auth, provider);
                    showMessage("Login realizado com sucesso! Verificando permissões...");
                } catch (error) {
                    console.error("Erro de login com Google:", error);
                    showMessage(`Erro de login: ${error.message}`);
                }
            });
            
            logoutButton.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    showMessage("Você saiu da sua conta.");
                } catch (error) {
                    console.error("Erro ao sair:", error);
                    showMessage(`Erro ao sair: ${error.message}`);
                }
            });
            
            onAuthStateChanged(auth, async (user) => {
                const statusDiv = document.getElementById('status-message');
                const authSection = document.getElementById('auth-section');
                const adminControlsDiv = document.getElementById('admin-controls');
                const currentUserEmailSpan = document.getElementById('currentUserEmail');
                
                if (user) {
                    authSection.style.display = 'none';
                    currentUserEmailSpan.textContent = user.email || 'Usuário';
                    
                    try {
                        const userDocRef = doc(db, "users", user.uid);
                        const userDocSnap = await getDoc(userDocRef);
                        
                        if (userDocSnap.exists() && userDocSnap.data().isAdmin === true) {
                            isUserAdmin = true;
                            statusDiv.textContent = `Autenticado como administrador (${user.uid}). Você pode salvar e abrir conteúdo.`;
                            statusDiv.className = 'text-center text-lg font-semibold p-4 rounded-lg bg-green-200 text-green-800';
                            adminControlsDiv.style.display = 'block';
                        } else {
                            isUserAdmin = false;
                            statusDiv.textContent = `Autenticado, mas você não é um administrador. Seu UID é: ${user.uid}. O acesso é restrito.`;
                            statusDiv.className = 'text-center text-lg font-semibold p-4 rounded-lg bg-yellow-200 text-yellow-800';
                            adminControlsDiv.style.display = 'none';
                        }
                    } catch (error) {
                        console.error("Erro ao verificar status de admin:", error);
                        isUserAdmin = false;
                        statusDiv.textContent = `Erro ao verificar status de admin: ${error.message}`;
                        statusDiv.className = 'text-center text-lg font-semibold p-4 rounded-lg bg-red-200 text-red-800';
                        adminControlsDiv.style.display = 'none';
                    }
                } else {
                    isUserAdmin = false;
                    statusDiv.textContent = "Por favor, faça login para continuar.";
                    statusDiv.className = 'text-center text-lg font-semibold p-4 rounded-lg bg-gray-200 text-gray-800';
                    authSection.style.display = 'block';
                    adminControlsDiv.style.display = 'none';
                }
            });
            
            // --- Funções do Firestore (CMS) ---
            const collectionName = "HTML2W";
            
            window.saveContent = async function() {
                if (!isUserAdmin) {
                    showMessage('Você não tem permissão para salvar conteúdo. Apenas administradores podem fazer isso.');
                    return;
                }
                
                const documentName = document.getElementById('documentName').value.trim();
                const internalName = document.getElementById('internalName').value.trim();
                const content = document.getElementById('content').value;
                
                if (!documentName || !internalName || !content) {
                    showMessage('Por favor, preencha todos os campos.');
                    return;
                }
                
                try {
                    const docRef = doc(db, collectionName, documentName);
                    await setDoc(docRef, {
                        nomeInterno: internalName,
                        conteudo: content,
                        userId: auth.currentUser.uid,
                        timestamp: serverTimestamp()
                    });
                    showMessage(`Documento "${documentName}" salvo com sucesso!`);
                    
                    document.getElementById('documentName').value = '';
                    document.getElementById('internalName').value = '';
                    document.getElementById('content').value = '';
                } catch (error) {
                    console.error("Erro ao salvar documento:", error);
                    showMessage(`Erro ao salvar documento: ${error.message}`);
                }
            }
            
            window.openContent = async function() {
                if (!isUserAdmin) {
                    showMessage('Você não tem permissão para ler este conteúdo. Apenas administradores podem fazer isso.');
                    return;
                }
                
                const openDocumentName = document.getElementById('openDocumentName').value.trim();
                const displayInternalName = document.getElementById('displayInternalName').querySelector('span');
                const displayContent = document.getElementById('displayContent').querySelector('span');
                
                displayInternalName.textContent = 'N/A';
                displayContent.textContent = 'N/A';
                
                if (!openDocumentName) {
                    showMessage('Por favor, insira o nome do documento para abrir.');
                    return;
                }
                
                try {
                    const docRef = doc(db, collectionName, openDocumentName);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        displayInternalName.textContent = data.nomeInterno || 'N/A';
                        displayContent.textContent = data.conteudo || 'N/A';
                        showMessage(`Documento "${openDocumentName}" carregado com sucesso!`);
                    } else {
                        showMessage(`Documento "${openDocumentName}" não encontrado.`);
                    }
                } catch (error) {
                    console.error("Erro ao abrir documento:", error);
                    showMessage(`Erro ao abrir documento: ${error.message}`);
                }
            }
            
            // Função para copiar a URL pública
            window.copyPublicUrl = function() {
                const docId = document.getElementById('openDocumentName').value.trim();
                if (!docId) {
                    showMessage('Por favor, insira o nome do documento para gerar a URL.');
                    return;
                }
                
                const publicUrl = `https://${publicUrlDomain}${publicUrlPathPrefix}${docId}/index.html`;
                
                // Usa document.execCommand para copiar o texto para a área de transferência
                const tempInput = document.createElement('input');
                tempInput.value = publicUrl;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                
                showMessage(`URL pública copiada: ${publicUrl}`);
            }
        }
    </script>
</body>
</html>
