<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Firebase Firestore CLI - JSON Config</title>
  <style>
    body {
      background-color: #1c1c1c;
      color: #00ff00;
      font-family: 'Courier New', Courier, monospace;
      padding: 20px;
    }
    #terminal {
      background-color: #000;
      border: 1px solid #00ff00;
      padding: 10px;
      height: 600px;
      overflow-y: scroll;
      white-space: pre-wrap;
    }
    #input-line {
      display: flex;
      margin-top: 10px;
    }
    #prompt {
      color: #00ff00;
      margin-right: 5px;
    }
    #command-input {
      background: none;
      border: none;
      color: #00ff00;
      flex-grow: 1;
      caret-color: #00ff00;
    }
    #command-input:focus {
      outline: none;
    }
    .output-success {
      color: #00ff00;
    }
    .output-error {
      color: #ff0000;
    }
    .output-info {
      color: #add8e6;
    }
    .output-warn {
      color: #ffff00;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>

  <h1>Firebase Firestore CLI</h1>
  <div id="terminal"></div>
  <div id="input-line">
    <span id="prompt">firestore-cli ></span>
    <input type="text" id="command-input" autofocus />
  </div>

<script>
  const terminal = document.getElementById('terminal');
  const commandInput = document.getElementById('command-input');
  
  let commandsConfig = null; // Para armazenar os comandos do JSON
  let firebaseInstance = null;
  let db = null;

  function appendOutput(text, className = '') {
    const p = document.createElement('p');
    p.textContent = text;
    if (className) p.classList.add(className);
    terminal.appendChild(p);
    terminal.scrollTop = terminal.scrollHeight;
  }

  // Mapeia os nomes das funções para as funções reais
  const functionMap = {
    'scanCollection': scanCollection
  };

  async function loadCommands() {
    try {
      appendOutput('Carregando comandos...', 'output-info');
      const response = await fetch('commands.json');
      if (!response.ok) {
        throw new Error(`Erro ao carregar commands.json: ${response.statusText}`);
      }
      commandsConfig = await response.json();
      
      // Inicializa o Firebase com as configurações do JSON
      firebaseInstance = firebase.initializeApp(commandsConfig.firebaseConfig);
      db = firebaseInstance.firestore();
      
      appendOutput('Comandos e configurações do Firebase carregados com sucesso.');
      appendOutput('Bem-vindo ao Firebase Firestore CLI.');
      appendOutput('Digite "help" para ver os comandos disponíveis.');
    } catch (error) {
      appendOutput(`Erro fatal: ${error.message}`, 'output-error');
    }
  }

  // --- Funções de comando ---
  async function scanCollection(args) {
    const collectionName = args[0];
    if (!collectionName) {
      appendOutput('Erro: Nome da coleção não fornecido. Use "scan <collection>" ou "scan all".', 'output-error');
      return;
    }

    if (collectionName === 'all') {
      await scanAllCollections();
      return;
    }
    
    try {
      appendOutput(`Escaneando coleção "${collectionName}"...`, 'output-info');
      const snapshot = await db.collection(collectionName).get();
      
      let docCount = 0;
      let fieldCount = 0;
      
      snapshot.forEach(doc => {
        docCount++;
        const data = doc.data();
        fieldCount += Object.keys(data).length;
      });
      
      appendOutput(`- Coleção "${collectionName}":`, 'output-success');
      appendOutput(`  - Total de documentos: ${docCount}`);
      appendOutput(`  - Total de campos: ${fieldCount}`);
      
    } catch (error) {
      if (error.code === 'permission-denied') {
        appendOutput(`  - ERRO: Permissão negada para ler a coleção "${collectionName}".`, 'output-error');
      } else {
        appendOutput(`  - Ocorreu um erro ao escanear a coleção "${collectionName}": ${error.message}`, 'output-error');
      }
    }
  }
  
  async function scanAllCollections() {
    try {
      appendOutput('Buscando todas as coleções... (Isso pode demorar)', 'output-info');
      const collectionsSnapshot = await db.listCollections();
      
      if (collectionsSnapshot.length === 0) {
        appendOutput('Nenhuma coleção encontrada.', 'output-warn');
        return;
      }
      
      for (const collectionRef of collectionsSnapshot) {
        await scanCollection([collectionRef.id]);
      }
      appendOutput('Varredura de todas as coleções concluída.', 'output-success');
      
    } catch (error) {
      appendOutput(`Ocorreu um erro ao buscar coleções: ${error.message}`, 'output-error');
    }
  }

  async function processCommand(input) {
    appendOutput(`firestore-cli > ${input}`);
    const parts = input.trim().split(/\s+/);
    const commandName = parts[0];
    const args = parts.slice(1);
    
    const commandDef = commandsConfig.commands.find(cmd => cmd.name === commandName);
    
    if (!commandDef) {
      appendOutput(`Comando não reconhecido: "${commandName}". Digite 'help' para ver os comandos.`, 'output-error');
      return;
    }
    
    switch (commandDef.action) {
      case 'display':
        commandDef.output.forEach(line => {
          let outputLine = line;
          // Substitui os placeholders do JSON
          outputLine = outputLine.replace(/\$firebase\.projectId/g, commandsConfig.firebaseConfig.projectId);
          outputLine = outputLine.replace(/\$firebase\.apiKey/g, commandsConfig.firebaseConfig.apiKey);
          appendOutput(outputLine);
        });
        break;
      case 'clear':
        terminal.innerHTML = '';
        break;
      case 'execute':
        const func = functionMap[commandDef.function];
        if (func) {
          await func(args);
        } else {
          appendOutput(`Erro interno: Função "${commandDef.function}" não encontrada.`, 'output-error');
        }
        break;
      default:
        appendOutput('Erro: Ação desconhecida no JSON de comando.', 'output-error');
    }
  }

  commandInput.addEventListener('keydown', (event) => {
    if (event.key === 'Enter') {
      const commandText = commandInput.value.trim();
      if (commandText) {
        processCommand(commandText);
      }
      commandInput.value = '';
    }
  });

  window.onload = loadCommands;
</script>

</body>
</html>
