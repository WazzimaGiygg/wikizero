<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Firebase Firestore CLI</title>
  <style>
    body {
      background-color: #1c1c1c;
      color: #00ff00;
      font-family: 'Courier New', Courier, monospace;
      padding: 20px;
    }
    #terminal {
      background-color: #000;
      border: 1px solid #00ff00;
      padding: 10px;
      height: 600px;
      overflow-y: scroll;
      white-space: pre-wrap;
    }
    #input-line {
      display: flex;
      margin-top: 10px;
    }
    #prompt {
      color: #00ff00;
      margin-right: 5px;
    }
    #command-input {
      background: none;
      border: none;
      color: #00ff00;
      flex-grow: 1;
      caret-color: #00ff00;
    }
    #command-input:focus {
      outline: none;
    }
    .output-success {
      color: #00ff00;
    }
    .output-error {
      color: #ff0000;
    }
    .output-info {
      color: #add8e6;
    }
    .output-warn {
      color: #ffff00;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>

  <h1>Firebase Firestore CLI</h1>
  <div id="terminal"></div>
  <div id="input-line">
    <span id="prompt">firestore-cli ></span>
    <input type="text" id="command-input" autofocus />
  </div>

<script>
  // =================================================================
  // Substitua este objeto com a sua própria configuração do Firebase
  // =================================================================
  const firebaseConfig = {
    apiKey: "SUA_API_KEY",
    authDomain: "SEU_AUTH_DOMAIN",
    projectId: "SEU_PROJECT_ID",
    storageBucket: "SEU_STORAGE_BUCKET",
    messagingSenderId: "SEU_MESSAGING_SENDER_ID",
    appId: "SEU_APP_ID"
  };

  // Inicializa o Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const terminal = document.getElementById('terminal');
  const commandInput = document.getElementById('command-input');
  const prompt = document.getElementById('prompt');

  // Adiciona uma linha de texto ao terminal
  function appendOutput(text, className = '') {
    const p = document.createElement('p');
    p.textContent = text;
    if (className) p.classList.add(className);
    terminal.appendChild(p);
    terminal.scrollTop = terminal.scrollHeight; // Auto-scroll para baixo
  }

  // Comandos disponíveis
  const commands = {
    'help': () => {
      appendOutput('Comandos disponíveis:');
      appendOutput('  scan <collection> - Escaneia uma coleção e mostra estatísticas.');
      appendOutput('  scan all - Escaneia todas as coleções. (Atenção: pode ser lento!)');
      appendOutput('  clear - Limpa o terminal.');
      appendOutput('  help - Exibe esta ajuda.');
    },
    'clear': () => {
      terminal.innerHTML = '';
    }
  };

  // Função principal para processar o comando
  async function processCommand(input) {
    appendOutput(`firestore-cli > ${input}`);
    const [command, ...args] = input.trim().split(/\s+/);
    
    if (command === 'clear') {
      commands.clear();
      return;
    }
    if (command === 'help') {
      commands.help();
      return;
    }
    
    if (command === 'scan') {
      const collectionName = args[0];
      if (!collectionName) {
        appendOutput('Erro: Nome da coleção não fornecido. Use "scan <collection>" ou "scan all".', 'output-error');
        return;
      }
      
      if (collectionName === 'all') {
        await scanAllCollections();
      } else {
        await scanCollection(collectionName);
      }
      return;
    }
    
    appendOutput(`Comando não reconhecido: "${command}". Digite 'help' para ver os comandos.`, 'output-error');
  }

  // Função para escanear uma única coleção
  async function scanCollection(collectionName) {
    try {
      appendOutput(`Escaneando coleção "${collectionName}"...`, 'output-info');
      const snapshot = await db.collection(collectionName).get();
      
      let docCount = 0;
      let fieldCount = 0;
      
      snapshot.forEach(doc => {
        docCount++;
        const data = doc.data();
        fieldCount += Object.keys(data).length;
      });
      
      appendOutput(`- Coleção "${collectionName}":`, 'output-success');
      appendOutput(`  - Total de documentos: ${docCount}`);
      appendOutput(`  - Total de campos: ${fieldCount}`);
      
    } catch (error) {
      if (error.code === 'permission-denied') {
        appendOutput(`  - ERRO: Permissão negada para ler a coleção "${collectionName}".`, 'output-error');
        appendOutput(`    Verifique as regras de segurança do Firebase Firestore.`, 'output-error');
      } else if (error.message.includes('No document to be read')) {
         appendOutput(`  - ERRO: A coleção "${collectionName}" não existe ou está vazia.`, 'output-warn');
      } else {
        appendOutput(`  - Ocorreu um erro ao escanear a coleção "${collectionName}": ${error.message}`, 'output-error');
      }
    }
  }

  // Função para escanear todas as coleções
  async function scanAllCollections() {
    try {
      appendOutput('Buscando todas as coleções... (Isso pode demorar)', 'output-info');
      
      // Nota: Esta é uma maneira de obter nomes de coleções no Firestore Web SDK
      // que requer que você tenha ao menos 1 documento em cada coleção.
      // Se a coleção estiver vazia, ela não aparecerá na lista.
      const snapshot = await db.listCollections();
      
      if (snapshot.length === 0) {
        appendOutput('Nenhuma coleção encontrada.', 'output-warn');
        return;
      }
      
      for (const collectionRef of snapshot) {
        await scanCollection(collectionRef.id);
      }
      appendOutput('Varredura de todas as coleções concluída.', 'output-success');
      
    } catch (error) {
      appendOutput(`Ocorreu um erro ao buscar coleções: ${error.message}`, 'output-error');
    }
  }

  // Listener para a tecla Enter
  commandInput.addEventListener('keydown', (event) => {
    if (event.key === 'Enter') {
      const commandText = commandInput.value.trim();
      if (commandText) {
        processCommand(commandText);
      }
      commandInput.value = ''; // Limpa a entrada após o comando
    }
  });

  // Mensagem de boas-vindas
  window.onload = () => {
    appendOutput('Bem-vindo ao Firebase Firestore CLI.');
    appendOutput('Digite "help" para ver os comandos disponíveis.');
  };
</script>

</body>
</html>
