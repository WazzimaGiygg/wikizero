<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Posts do Fórum (Somente Leitura) - Wiki Zone Zero Mod</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.bubble.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', 'Helvetica', Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 20px auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 2px 0 rgba(0,0,0,.14), 0 3px 1px -2px rgba(0,0,0,.2), 0 1px 5px 0 rgba(0,0,0,.12);
        }
        h1 {
            color: #3f51b5;
            margin-bottom: 25px;
            text-align: center;
        }
        .post-card {
            background-color: #fff;
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 2px 0 rgba(0,0,0,.14), 0 3px 1px -2px rgba(0,0,0,.2), 0 1px 5px 0 rgba(0,0,0,.12);
        }
        .post-card h3 {
            color: #3f51b5;
            margin-top: 0;
            margin-bottom: 10px;
        }
        .post-meta {
            font-size: 0.9em;
            color: #757575;
            margin-bottom: 15px;
        }
        .post-content {
            border-top: 1px solid #eee;
            padding-top: 15px;
            margin-top: 15px;
        }
        .post-actions {
            text-align: right;
            margin-top: 15px;
        }
        /* Estilos para links que se parecem com botões */
        .post-actions .mdl-button { /* Mantendo a classe mdl-button para o link "Ver Post" */
            margin-left: 10px;
            width: auto;
            text-decoration: none; /* Remover sublinhado padrão do link */
            display: inline-block; /* Para que margin e padding funcionem como em um botão */
            padding: 0 16px; /* Padding padrão do MDL button */
            line-height: 36px; /* Altura da linha padrão do MDL button */
            height: 36px; /* Altura padrão do MDL button */
            border-radius: 2px; /* Arredondamento padrão do MDL button */
            cursor: pointer;
            text-align: center;
            white-space: nowrap;
            color: #fff; /* Cor do texto padrão para botões coloridos */
            background-color: #3f51b5; /* Cor primária do MDL para o link "Ver Post" */
        }
        .loading-message, .no-posts-message, .error-message {
            text-align: center;
            padding: 20px;
            color: #757575;
        }
        .error-message {
            color: #d32f2f;
            background-color: #ffebee;
            border: 1px solid #d32f2f;
            border-radius: 5px;
            margin-top: 20px;
        }
        /* Quill Bubble Theme adjustments for display */
        .ql-bubble.ql-editor {
            padding: 0;
            border: none;
        }
        .ql-bubble.ql-editor.ql-blank::before {
            left: 0;
        }
    </style>
</head>
<body>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <div class="container">
        <h1>Posts do Fórum</h1>

        <div id="posts-list">
            <p class="loading-message">Carregando posts do fórum...</p>
        </div>

        <div id="error-display" class="error-message" style="display:none;"></div>
    </div>

    <script>
        // --- Configuração do Firebase ---
        // A chave de API do Firebase é para acesso público.
        // As regras do Firestore devem permitir leitura sem autenticação para a coleção 'forum'.
        const firebaseConfig = {
            apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0",
            authDomain: "wzzm-ce3fc.firebaseapp.com",
            projectId: "wzzm-ce3fc",
            storageBucket: "wzzm-ce3fc.appspot.com",
            messagingSenderId: "249427877153",
            appId: "1:249427877153:web:0e4297294794a5aadeb260",
            measurementId: "G-PLKNZNFCQ8"
        };

        let app;
        try {
            app = firebase.app();
        } catch (e) {
            app = firebase.initializeApp(firebaseConfig);
        }
        const firestore = firebase.firestore();

        const postsListDiv = document.getElementById('posts-list');
        const errorDisplay = document.getElementById('error-display');

        function displayError(message) {
            errorDisplay.textContent = `Erro: ${message}`;
            errorDisplay.style.display = 'block';
        }

        // --- Função para carregar e exibir os posts do fórum (somente leitura) ---
        async function loadForumPosts() {
            postsListDiv.innerHTML = '<p class="loading-message">Carregando posts do fórum...</p>';
            errorDisplay.style.display = 'none';

            try {
                // Consulta a coleção 'forum' ordenada por 'createdAt' (mais recente primeiro)
                // Esta consulta NÃO precisa de autenticação se suas regras do Firestore permitirem leitura pública.
                const querySnapshot = await firestore.collection('forum')
                                                    .orderBy('createdAt', 'desc')
                                                    .get();

                if (querySnapshot.empty) {
                    postsListDiv.innerHTML = '<p class="no-posts-message">Nenhum post encontrado no fórum.</p>';
                    return;
                }

                postsListDiv.innerHTML = ''; // Limpa a mensagem de carregamento

                querySnapshot.forEach(doc => {
                    const post = doc.data();
                    const postId = doc.id;

                    const postCard = document.createElement('div');
                    postCard.classList.add('post-card');

                    const createdAtDate = post.createdAt ? post.createdAt.toDate() : new Date();
                    const formattedDate = createdAtDate.toLocaleString('pt-BR', {
                        year: 'numeric', month: 'long', day: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });

                    // HTML para o cartão da postagem - SOMENTE O LINK "Ver Post"
                    postCard.innerHTML = `
                        <h3>${post.title || 'Sem Título'}</h3>
                        <p class="post-meta">
                            Por: ${post.userName || 'Desconhecido'} em ${formattedDate}
                        </p>
                        <div id="post-content-${postId}" class="post-content"></div>
                        <div class="post-actions">
                            <a href="#" class="mdl-button mdl-js-button mdl-button--raised mdl-button--primary view-post-link" data-id="${postId}">
                                Ver Post
                            </a>
                        </div>
                    `;
                    postsListDiv.appendChild(postCard);

                    // Recompila e exibe o conteúdo formatado usando Quill (read-only)
                    const contentDiv = document.getElementById(`post-content-${postId}`);
                    if (post.formattedContent && contentDiv) {
                        try {
                            const quillDisplay = new Quill(contentDiv, {
                                theme: 'bubble', // Um tema mais leve para exibição
                                readOnly: true,
                                modules: { toolbar: false } // Sem barra de ferramentas
                            });
                            const delta = JSON.parse(post.formattedContent);
                            quillDisplay.setContents(delta);
                        } catch (parseError) {
                            console.error("Erro ao parsear conteúdo formatado do Quill:", parseError);
                            contentDiv.innerHTML = `<p style="color:red;">Erro ao carregar conteúdo formatado.</p><pre>${post.formattedContent}</pre>`;
                        }
                    } else if (contentDiv) {
                        contentDiv.innerHTML = '<p>Nenhum conteúdo disponível.</p>';
                    }
                });

                // Adiciona listeners para os links "Ver Post"
                document.querySelectorAll('.view-post-link').forEach(link => {
                    link.addEventListener('click', (event) => {
                        event.preventDefault(); // Impede o comportamento padrão do link
                        const postId = event.target.dataset.id;
                        const urlToNavigate = `./detalhes-do-post.html?id=${postId}`;

                        // Verifica se está dentro de um iframe para usar postMessage
                        if (window.parent !== window && window.parent.postMessage) {
                            window.parent.postMessage({ type: 'navigateIframe', url: urlToNavigate }, window.location.origin);
                        } else {
                            // Se não estiver em um iframe, navega diretamente
                            window.location.href = urlToNavigate;
                        }
                    });
                });

                // Atualiza os componentes MDL após o carregamento dinâmico
                if (window.componentHandler) {
                    window.componentHandler.upgradeDom();
                }

            } catch (error) {
                console.error("Erro ao carregar posts do fórum:", error);
                displayError("Erro ao carregar posts do fórum: " + error.message);
            }
        }

        // Carrega os posts assim que a página é carregada
        document.addEventListener('DOMContentLoaded', loadForumPosts);
    </script>
</body>
</html>
