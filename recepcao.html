<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fórum da Wiki Zone Zero Mod</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
             /* Variáveis de Cores (Opcional, mas útil para consistência) */
        :root {
            --primary-color: #3f51b5; /* Azul Índigo do MDL */
            --primary-dark-color: #303f9f;
            --accent-color: #ff4081; /* Rosa do MDL */
            --background-light: #f5f5f5;
            --background-dark: #e0e0e0;
            --text-color-primary: #333;
            --text-color-secondary: #666;
            --border-color: #ddd;
            --success-color: #4CAF50;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --info-color: #2196f3;
        }

        /* Base */
        body {
            font-family: 'Roboto', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-light);
            color: var(--text-color-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 960px;
            margin: 20px auto;
            padding: 30px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 20px;
            font-weight: 500;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }

        h2 {
            color: var(--primary-dark-color);
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.8em;
            font-weight: 400;
        }

        h3 {
            color: var(--text-color-primary);
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.4em;
            font-weight: 400;
        }

        hr {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 20px 0;
        }

        /* Form Elements */
        input[type="text"],
        textarea {
            width: calc(100% - 24px);
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        input[type="text"]:focus,
        textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(63, 81, 181, 0.2);
            outline: none;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Buttons */
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 1em;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .createForumBtn, .sendMessageBtn {
            background-color: var(--success-color);
            color: #fff;
        }

        .delete-btn {
            background-color: var(--danger-color);
            color: #fff;
        }

        .edit-btn {
            background-color: var(--warning-color);
            color: #fff;
        }

        .backToForumsBtn {
            background-color: var(--info-color);
            color: #fff;
        }

        #google-sign-in-btn {
            background-color: #4285f4; /* Cor do Google */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 15px auto;
            width: fit-content;
        }
        #google-sign-in-btn:hover {
            background-color: #357ae8;
        }
        #google-sign-in-btn .material-icons {
            font-size: 20px; /* Tamanho do ícone do Google */
        }


        /* Login Prompt */
        #loginPromptSection {
            text-align: center;
            padding: 20px;
            background-color: var(--background-dark);
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 1.1em;
            color: var(--text-color-secondary);
        }

        /* Forum List */
        ul#forumList {
            list-style: none;
            padding: 0;
        }

        ul#forumList li {
            background-color: var(--background-light);
            margin-bottom: 10px;
            padding: 15px 20px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        ul#forumList li:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        ul#forumList li a {
            flex-grow: 1;
            text-decoration: none;
            color: var(--primary-color);
            font-weight: bold;
            font-size: 1.2em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 15px;
        }

        ul#forumList li span.forum-date {
            color: var(--text-color-secondary);
            font-size: 0.9em;
            margin-left: 15px;
        }

        .forum-actions {
            display: flex;
            gap: 5px; /* Espaço entre os botões de ação */
        }

        .forum-actions .mdl-button {
            min-width: 36px; /* Ajusta o tamanho dos botões de ícone */
            height: 36px;
            padding: 0;
        }

        /* Message Container */
        #messagesContainer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        #messagesContainer .message-item {
            background-color: #fff;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            position: relative; /* Para posicionar botões de ação */
        }

        #messagesContainer .message-item strong {
            color: var(--primary-dark-color);
            font-size: 1.1em;
        }

        #messagesContainer .message-item .timestamp {
            font-size: 0.85em;
            color: var(--text-color-secondary);
            margin-left: 8px;
        }

        #messagesContainer .message-item .message-content {
            margin-top: 10px;
            margin-bottom: 10px;
            color: var(--text-color-primary);
            line-height: 1.8; /* Melhorar legibilidade para HTML formatado */
        }

        /* Estilos para o Quill Editor */
        .ql-toolbar.ql-snow + .ql-container.ql-snow {
            border-top: 0px;
            height: auto; /* Permite que o editor cresça */
            min-height: 100px; /* Altura mínima */
        }
        .ql-container {
            border: 1px solid var(--border-color) !important; /* Sobrescreve a borda padrão do Quill */
            border-radius: 4px;
            font-size: 1em;
            line-height: 1.6;
        }
        .ql-editor {
            min-height: 100px;
        }

        .message-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .message-actions .mdl-button {
            min-width: 30px;
            height: 30px;
            padding: 0;
        }

        .forum-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        #forumDetailSubject {
            color: var(--primary-dark-color);
            flex-grow: 1;
            margin: 0;
            font-size: 2em;
            font-weight: 500;
        }


        /* Esconder seções inicialmente */
        #createForumSection,
        #forumDetailSection {
            display: none;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 20px;
            }

            h1 {
                font-size: 1.8em;
            }

            h2 {
                font-size: 1.5em;
            }

            ul#forumList li {
                flex-direction: column;
                align-items: flex-start;
                padding: 10px 15px;
            }

            ul#forumList li a {
                font-size: 1.1em;
                margin-right: 0;
                margin-bottom: 5px;
            }

            ul#forumList li span.forum-date {
                font-size: 0.8em;
                margin-left: 0;
            }

            .forum-actions {
                width: 100%;
                justify-content: flex-end;
                margin-top: 10px;
            }

            .message-actions {
                position: static;
                margin-top: 10px;
                justify-content: flex-end;
                width: 100%;
            }

            #forumDetailSubject {
                font-size: 1.5em;
                margin-bottom: 10px;
            }
            .forum-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Fórum</h1>

        <div id="loginPromptSection">
            <p>Por favor, faça login para criar fóruns e participar das discussões.</p>
            <button class="mdl-button mdl-js-button mdl-button--raised" id="google-sign-in-btn">
                <i class="material-icons">account_circle</i> Entrar com Google
            </button>
            <p>
                <button class="mdl-button mdl-js-button mdl-button--raised" id="sign-out-btn" style="display: none;">Sair</button>
            </p>
            <p id="user-info" style="display: none;"></p>
        </div>

        <div id="createForumSection">
            <h2>Criar Novo Fórum</h2>
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" style="width: 100%;">
                <input class="mdl-textfield__input" type="text" id="forumSubject">
                <label class="mdl-textfield__label" for="forumSubject">Assunto do Fórum</label>
            </div>
            <label for="firstMessageEditor">Primeira mensagem do fórum:</label>
            <div id="firstMessageEditor" style="height: 150px; margin-bottom: 12px;"></div>
            <button class="mdl-button mdl-js-button mdl-button--raised createForumBtn" id="createForumBtn">Criar Fórum</button>
            <hr>
        </div>

        <div id="listForumsSection">
            <h2>Fóruns Disponíveis</h2>
            <ul id="forumList">
                <li>Carregando fóruns...</li>
            </ul>
        </div>

        <div id="forumDetailSection">
            <div class="forum-header">
                <h2 id="forumDetailSubject"></h2>
                <button class="mdl-button mdl-js-button mdl-button--raised backToForumsBtn" id="backToForumsBtn">Voltar para a Lista</button>
            </div>
            <div id="messagesContainer">
                </div>
            <h3>Sua Mensagem:</h3>
            <label for="newMessageEditor">Sua mensagem:</label>
            <div id="newMessageEditor" style="height: 150px; margin-bottom: 12px;"></div>
            <button class="mdl-button mdl-js-button mdl-button--raised sendMessageBtn" id="sendMessageBtn">Enviar Mensagem</button>
        </div>
    </div>

    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script>
        // Your web app's Firebase configuration
        // Para Firebase JS SDK v7.20.0 e posterior, measurementId é opcional
        const firebaseConfig = {
            apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0", // Use sua própria chave! /* cite: 79 */
            authDomain: "wzzm-ce3fc.firebaseapp.com", /* cite: 79 */
            projectId: "wzzm-ce3fc", /* cite: 79 */
            storageBucket: "wzzm-ce3fc.appspot.com", /* cite: 79 */
            messagingSenderId: "249427877153", /* cite: 79 */
            appId: "1:249427877153:web:0e4297294794a5aadeb260", /* cite: 79 */
            measurementId: "G-PLKNZNFCQ8" /* cite: 79 */
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage(); // Inicializa o Firebase Storage

        let currentUser = null;
        let currentUserIsAdmin = false;
        let currentLoadedForumId = null;
        let currentLoadedForumUserId = null;

        // Elementos UI para autenticação
        const googleSignInBtn = document.getElementById('google-sign-in-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const userInfoSpan = document.getElementById('user-info');
        const loginPromptSection = document.getElementById('loginPromptSection');
        const createForumSection = document.getElementById('createForumSection');

        // Variáveis para os editores Quill
        let firstMessageQuill;
        let newMessageQuill;

        // Manipulador de upload de imagem para Quill
        async function imageHandler(quillInstance) {
            const input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', 'image/*');
            input.click();

            input.onchange = async () => {
                const file = input.files[0];
                if (file) {
                    const range = quillInstance.getSelection(true); // Obtenha a seleção atual do cursor

                    // Opcional: Mostrar um loader ou texto enquanto carrega
                    quillInstance.clipboard.dangerouslyPasteHTML(range.index, '<p>Carregando imagem...</p>');

                    const storageRef = storage.ref();
                    const imagesRef = storageRef.child(`forum_images/${Date.now()}-${file.name}`);

                    try {
                        const snapshot = await imagesRef.put(file);
                        const downloadURL = await snapshot.ref.getDownloadURL();

                        // Remove o texto de carregamento e insere a imagem
                        const currentContent = quillInstance.root.innerHTML;
                        const newContent = currentContent.replace('<p>Carregando imagem...</p>', '');
                        quillInstance.root.innerHTML = newContent;
                        quillInstance.insertEmbed(range.index, 'image', downloadURL);
                        quillInstance.setSelection(range.index + 1); // Move o cursor após a imagem
                    } catch (error) {
                        console.error("Erro ao fazer upload da imagem:", error);
                        alert("Erro ao fazer upload da imagem: " + error.message);
                        // Remover o texto de carregamento em caso de erro
                        const currentContent = quillInstance.root.innerHTML;
                        const newContent = currentContent.replace('<p>Carregando imagem...</p>', '');
                        quillInstance.root.innerHTML = newContent;
                    }
                }
            };
        }


        // Inicializa Quill editors quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', () => {
            firstMessageQuill = new Quill('#firstMessageEditor', {
                theme: 'snow',
                placeholder: 'Primeira mensagem do fórum...',
                modules: {
                    toolbar: {
                        container: [
                            ['bold', 'italic', 'underline', 'strike'],
                            ['blockquote', 'code-block'],
                            [{ 'header': 1 }, { 'header': 2 }],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            [{ 'script': 'sub'}, { 'script': 'super' }],
                            [{ 'indent': '-1'}, { 'indent': '+1' }],
                            [{ 'direction': 'rtl' }],
                            [{ 'size': ['small', false, 'large', 'huge'] }],
                            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                            [{ 'color': [] }, { 'background': [] }],
                            [{ 'font': [] }],
                            [{ 'align': [] }],
                            ['link', 'image', 'video'],
                            ['clean']
                        ],
                        handlers: {
                            'image': function() {
                                imageHandler(this.quill);
                            }
                        }
                    }
                }
            });

            newMessageQuill = new Quill('#newMessageEditor', {
                theme: 'snow',
                placeholder: 'Sua mensagem...',
                modules: {
                    toolbar: {
                        container: [
                            ['bold', 'italic', 'underline', 'strike'],
                            ['blockquote', 'code-block'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            ['link', 'image', 'video'],
                            ['clean']
                        ],
                        handlers: {
                            'image': function() {
                                imageHandler(this.quill);
                            }
                        }
                    }
                }
            });
        });

        // Configuração do provedor de autenticação Google
        const provider = new firebase.auth.GoogleAuthProvider();

        // Event listener para o botão de login com Google
        googleSignInBtn.addEventListener('click', async () => {
            try {
                await auth.signInWithPopup(provider);
                // auth.onAuthStateChanged irá lidar com o resto
            } catch (error) {
                console.error("Erro ao fazer login com Google:", error);
                alert("Erro ao fazer login com Google: " + error.message);
            }
        });

        // Event listener para o botão de logout
        signOutBtn.addEventListener('click', async () => {
            try {
                await auth.signOut();
            } catch (error) {
                console.error("Erro ao fazer logout:", error);
                alert("Erro ao fazer logout: " + error.message);
            }
        });


        auth.onAuthStateChanged(async (user) => {
            currentUser = user;
            currentUserIsAdmin = false; // Reset admin status

            if (user) {
                googleSignInBtn.style.display = 'none';
                signOutBtn.style.display = 'inline-block';
                userInfoSpan.style.display = 'block';
                userInfoSpan.innerText = `Logado como: ${user.displayName || user.email}`;

                // Verifica/cria o perfil do usuário no Firestore e define o status de admin
                try {
                    const userDocRef = db.collection('users').doc(user.uid);
                    const userDoc = await userDocRef.get();

                    if (userDoc.exists) {
                        currentUserIsAdmin = userDoc.data().isAdmin || false;
                    } else {
                        // Novo usuário, cria um documento básico para ele
                        await userDocRef.set({
                            uid: user.uid,
                            displayName: user.displayName || 'Usuário Sem Nome',
                            email: user.email,
                            isAdmin: false, // Por padrão, não é admin. Admin status deve ser definido manualmente no Firestore.
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        console.log("Novo perfil de usuário criado no Firestore.");
                        currentUserIsAdmin = false; // Garante que o novo usuário não seja admin
                    }
                } catch (error) {
                    console.error("Erro ao carregar/criar perfil do usuário:", error);
                }

                createForumSection.style.display = 'block';
                loginPromptSection.style.display = 'block'; // Mantenha visível para o botão de sair e info
            } else {
                googleSignInBtn.style.display = 'inline-block';
                signOutBtn.style.display = 'none';
                userInfoSpan.style.display = 'none';
                userInfoSpan.innerText = '';
                createForumSection.style.display = 'none';
                loginPromptSection.style.display = 'block';
            }
            displayForums(); // Sempre exibe fóruns, mas ajusta visibilidade/ações com base na autenticação
        });

        document.getElementById('createForumBtn').addEventListener('click', async () => {
            if (!currentUser) {
                alert("Você precisa estar logado para criar um fórum.");
                return;
            }

            const subject = document.getElementById('forumSubject').value.trim();
            const firstContent = firstMessageQuill.root.innerHTML.trim(); // Pega o HTML do editor Quill

            if (!subject) {
                alert("Por favor, preencha o assunto do fórum.");
                return;
            }
            // Verifica se o conteúdo do editor Quill está vazio (<p><br></p> é o HTML padrão para vazio)
            if (firstContent === '<p><br></p>' || !firstContent) {
                alert("Por favor, preencha o conteúdo da primeira mensagem.");
                return;
            }

            try {
                // Criar o documento do fórum na subcoleção do usuário logado
                const newForumRef = await db.collection('users').doc(currentUser.uid).collection('forums').add({
                    subject: subject,
                    authorUid: currentUser.uid,
                    authorName: currentUser.displayName || currentUser.email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Adicionar a primeira mensagem como uma subcoleção do fórum recém-criado
                await newForumRef.collection('messages').add({
                    content: firstContent, // Salva o HTML
                    authorUid: currentUser.uid,
                    authorName: currentUser.displayName || currentUser.email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert("Fórum criado com sucesso!");
                document.getElementById('forumSubject').value = '';
                firstMessageQuill.setContents([]); // Limpa o conteúdo do editor Quill
                displayForums(); // Recarrega a lista de fóruns
            } catch (error) {
                console.error("Erro ao criar fórum:", error);
                alert("Erro ao criar fórum: " + error.message);
            }
        });

        async function displayForums() {
            const forumListElement = document.getElementById('forumList');
            forumListElement.innerHTML = '<li>Carregando fóruns...</li>';

            let query;
            if (currentUserIsAdmin) {
                // Admins podem ver todos os fóruns através de uma collectionGroup query
                query = db.collectionGroup('forums').orderBy('createdAt', 'desc');
            } else if (currentUser) {
                // Usuários logados veem apenas seus próprios fóruns
                // Isso pode ser ajustado se você quiser que usuários logados vejam TUDO
                // Por exemplo: query = db.collectionGroup('forums').orderBy('createdAt', 'desc');
                query = db.collection('users').doc(currentUser.uid).collection('forums').orderBy('createdAt', 'desc');
            } else {
                // Não logado: nenhum fórum para exibir
                forumListElement.innerHTML = '<li>Faça login para visualizar seus fóruns.</li>';
                return;
            }

            try {
                const snapshot = await query.get();
                if (snapshot.empty) {
                    forumListElement.innerHTML = '<li>Nenhum fórum encontrado.</li>';
                    return;
                }

                forumListElement.innerHTML = '';
                snapshot.forEach(doc => {
                    const forum = doc.data();
                    const forumId = doc.id;
                    // Para collectionGroup, o UID do criador é o parent do documento 'forums'
                    const forumCreatorUid = doc.ref.parent.parent ? doc.ref.parent.parent.id : currentUser.uid; // Garante que o UID do criador seja correto

                    const li = document.createElement('li');
                    const date = forum.createdAt ? new Date(forum.createdAt.toDate()).toLocaleString() : 'Data desconhecida';

                    li.innerHTML = `
                        <a href="#" onclick="loadForumMessages('${forumCreatorUid}', '${forumId}', '${forum.subject}')">${forum.subject}</a>
                        <span class="forum-date">${date}</span>
                        <div class="forum-actions">
                            ${(currentUser && (currentUser.uid === forumCreatorUid || currentUserIsAdmin)) ? `
                                <button class="mdl-button mdl-js-button mdl-button--icon edit-btn" onclick="editForum('${forumCreatorUid}', '${forumId}', '${forum.subject}')" title="Editar">
                                    <i class="material-icons">edit</i>
                                </button>
                                <button class="mdl-button mdl-js-button mdl-button--icon delete-btn" onclick="deleteForum('${forumCreatorUid}', '${forumId}')" title="Remover">
                                    <i class="material-icons">delete</i>
                                </button>
                            ` : ''}
                        </div>
                    `;
                    forumListElement.appendChild(li);
                });
                // Garante que os componentes MDL sejam atualizados após adicionar novos elementos
                window.componentHandler.upgradeElements(forumListElement);
            } catch (error) {
                console.error("Erro ao carregar fóruns:", error);
                forumListElement.innerHTML = '<li>Erro ao carregar fóruns.</li>';
            }
        }

        async function editForum(forumCreatorUid, forumId, currentSubject) {
            if (!currentUser || (currentUser.uid !== forumCreatorUid && !currentUserIsAdmin)) {
                alert("Você não tem permissão para editar este fórum.");
                return;
            }

            const newSubject = prompt("Editar assunto do fórum:", currentSubject);
            if (newSubject && newSubject.trim() !== '') {
                try {
                    await db.collection('users').doc(forumCreatorUid).collection('forums').doc(forumId).update({
                        subject: newSubject.trim()
                    });
                    alert("Fórum atualizado com sucesso!");
                    displayForums(); // Recarrega a lista de fóruns
                } catch (error) {
                    console.error("Erro ao atualizar fórum:", error);
                    alert("Erro ao atualizar fórum: " + error.message);
                }
            } else if (newSubject !== null) { // Permite cancelar o prompt
                alert("O assunto não pode estar vazio.");
            }
        }

        async function deleteForum(forumCreatorUid, forumId) {
            if (!currentUser || (currentUser.uid !== forumCreatorUid && !currentUserIsAdmin)) {
                alert("Você não tem permissão para remover este fórum.");
                return;
            }

            if (confirm("Tem certeza que deseja remover este fórum e todas as suas mensagens?")) {
                try {
                    // Excluir todas as mensagens na subcoleção 'messages'
                    const messagesRef = db.collection('users').doc(forumCreatorUid).collection('forums').doc(forumId).collection('messages');
                    const messagesSnapshot = await messagesRef.get();
                    const batch = db.batch();
                    messagesSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();

                    // Excluir o documento do fórum
                    await db.collection('users').doc(forumCreatorUid).collection('forums').doc(forumId).delete();

                    alert("Fórum removido com sucesso!");
                    displayForums(); // Recarrega a lista de fóruns
                } catch (error) {
                    console.error("Erro ao remover fórum:", error);
                    alert("Erro ao remover fórum: " + error.message);
                }
            }
        }

        async function loadForumMessages(forumCreatorUid, forumId, forumSubject) {
            currentLoadedForumId = forumId;
            currentLoadedForumUserId = forumCreatorUid;
            document.getElementById('listForumsSection').style.display = 'none';
            createForumSection.style.display = 'none';
            //loginPromptSection.style.display = 'none'; // Não esconda completamente, pois contém sair/info
            document.getElementById('forumDetailSection').style.display = 'block';
            document.getElementById('forumDetailSubject').innerText = 'Fórum: ' + forumSubject;

            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = 'Carregando mensagens...';

            try {
                const querySnapshot = await db.collection('users').doc(forumCreatorUid).collection('forums').doc(forumId).collection('messages').orderBy('createdAt').get();

                if (querySnapshot.empty) {
                    messagesContainer.innerHTML = '<p>Nenhuma mensagem ainda neste fórum.</p>';
                    return;
                }

                messagesContainer.innerHTML = '';
                querySnapshot.forEach(doc => {
                    const message = doc.data();
                    const messageId = doc.id;
                    const date = message.createdAt ? new Date(message.createdAt.toDate()).toLocaleString() : 'Data desconhecida';
                    const senderName = message.authorName || 'Anônimo';

                    const messageElement = document.createElement('div');
                    messageElement.className = 'message-item';
                    messageElement.innerHTML = `
                        <strong>${senderName}</strong> <span class="timestamp">(${date})</span>
                        <div class="message-content">${message.content}</div> <div class="message-actions">
                            ${(currentUser && (currentUser.uid === message.authorUid || currentUserIsAdmin)) ? `
                                <button class="mdl-button mdl-js-button mdl-button--icon edit-btn" onclick="editMessage('${forumCreatorUid}', '${forumId}', '${messageId}', \`${message.content.replace(/`/g, '\\`')}\`)" title="Editar Mensagem">
                                    <i class="material-icons">edit</i>
                                </button>
                                <button class="mdl-button mdl-js-button mdl-button--icon delete-btn" onclick="deleteMessage('${forumCreatorUid}', '${forumId}', '${messageId}')" title="Remover Mensagem">
                                    <i class="material-icons">delete</i>
                                </button>
                            ` : ''}
                        </div>
                    `;
                    messagesContainer.appendChild(messageElement);
                });
                window.componentHandler.upgradeElements(messagesContainer);
            } catch (error) {
                console.error("Erro ao carregar mensagens:", error);
                messagesContainer.innerHTML = '<p>Erro ao carregar mensagens.</p>';
            }
        }

        async function editMessage(forumCreatorUid, forumId, messageId, currentContent) {
            // Obtenha o UID do autor da mensagem para verificação de permissão
            const messageDoc = await db.collection('users').doc(forumCreatorUid).collection('forums').doc(forumId).collection('messages').doc(messageId).get();
            if (!messageDoc.exists) {
                alert("Mensagem não encontrada.");
                return;
            }
            const messageAuthorUid = messageDoc.data().authorUid;

            if (!currentUser || (currentUser.uid !== messageAuthorUid && !currentUserIsAdmin)) {
                alert("Você não tem permissão para editar esta mensagem.");
                return;
            }

            // ATENÇÃO: Usar 'prompt' para editar HTML Rich Text não é ideal para UX, pois mostra o código bruto.
            // O ideal seria abrir um modal com um editor Quill pré-preenchido com 'currentContent'.
            const newContent = prompt("Editar mensagem (cuidado: isto mostrará o HTML bruto da mensagem):", currentContent);

            if (newContent && newContent.trim() !== '' && newContent.trim() !== '<p><br></p>') {
                try {
                    await db.collection('users').doc(forumCreatorUid).collection('forums').doc(forumId).collection('messages').doc(messageId).update({
                        content: newContent.trim(), // Salva o HTML editado
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert("Mensagem atualizada com sucesso!");
                    loadForumMessages(currentLoadedForumUserId, currentLoadedForumId, document.getElementById('forumDetailSubject').innerText.replace('Fórum: ', '')); // Recarrega mensagens
                } catch (error) {
                    console.error("Erro ao atualizar mensagem:", error);
                    alert("Erro ao atualizar mensagem: " + error.message);
                }
            } else if (newContent !== null) { // Permite cancelar o prompt
                alert("A mensagem não pode estar vazia.");
            }
        }

        async function deleteMessage(forumCreatorUid, forumId, messageId) {
            // Obtenha o UID do autor da mensagem para verificação de permissão
            const messageDoc = await db.collection('users').doc(forumCreatorUid).collection('forums').doc(forumId).collection('messages').doc(messageId).get();
            if (!messageDoc.exists) {
                alert("Mensagem não encontrada.");
                return;
            }
            const messageAuthorUid = messageDoc.data().authorUid;

            if (!currentUser || (currentUser.uid !== messageAuthorUid && !currentUserIsAdmin)) {
                alert("Você não tem permissão para remover esta mensagem.");
                return;
            }

            if (confirm("Tem certeza que deseja remover esta mensagem?")) {
                try {
                    await db.collection('users').doc(forumCreatorUid).collection('forums').doc(forumId).collection('messages').doc(messageId).delete();
                    alert("Mensagem removida com sucesso!");
                    loadForumMessages(currentLoadedForumUserId, currentLoadedForumId, document.getElementById('forumDetailSubject').innerText.replace('Fórum: ', '')); // Recarrega mensagens
                } catch (error) {
                    console.error("Erro ao remover mensagem:", error);
                    alert("Erro ao remover mensagem: " + error.message);
                }
            }
        }

        document.getElementById('sendMessageBtn').addEventListener('click', async () => {
            if (!currentUser) {
                alert("Você precisa estar logado para enviar mensagens.");
                return;
            }
            if (!currentLoadedForumId || !currentLoadedForumUserId) {
                alert("Nenhum fórum selecionado.");
                return;
            }

            const newMessageContent = newMessageQuill.root.innerHTML.trim(); // Pega o HTML do editor Quill

            if (newMessageContent === '<p><br></p>' || !newMessageContent) {
                alert("Por favor, digite sua mensagem.");
                return;
            }

            try {
                await db.collection('users').doc(currentLoadedForumUserId).collection('forums').doc(currentLoadedForumId).collection('messages').add({
                    content: newMessageContent, // Salva o HTML
                    authorUid: currentUser.uid,
                    authorName: currentUser.displayName || currentUser.email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                newMessageQuill.setContents([]); // Limpa o conteúdo do editor Quill
                // Recarrega as mensagens para exibir a nova
                loadForumMessages(currentLoadedForumUserId, currentLoadedForumId, document.getElementById('forumDetailSubject').innerText.replace('Fórum: ', ''));
            } catch (error) {
                console.error("Erro ao enviar mensagem:", error);
                alert("Ocorreu um erro ao enviar sua mensagem: " + error.message);
            }
        });

        document.getElementById('backToForumsBtn').addEventListener('click', () => {
            document.getElementById('forumDetailSection').style.display = 'none';
            document.getElementById('listForumsSection').style.display = 'block';
            if (currentUser) {
                createForumSection.style.display = 'block';
                loginPromptSection.style.display = 'block'; // Mantenha visível para o botão de sair e info
            } else {
                createForumSection.style.display = 'none';
                loginPromptSection.style.display = 'block';
            }
            displayForums(); // Recarrega a lista de fóruns
        });

        // Chamada inicial para carregar os fóruns
        // Isso será disparado pelo onAuthStateChanged quando o Firebase carregar o estado de autenticação
    </script>
</body>
</html>
